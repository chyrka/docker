#!/bin/bash

set -ex

# VARIABLES
FTP_ADM_NAME=${FTP_ADM_NAME:-"ftpadm"}
FTP_ADM_PASS=${FTP_ADM_PASS:-"1qaz@WSX"}

# SIGTERM handler
function _term() {

   echo "Stopping container."
   echo "SIGTERM received, shutting down the server!"
   kill -15 $childPID
   exit 0 # 128+15

}

# SIGKILL handler
function _kill() {

   echo "SIGKILL received, shutting down the server!"
   kill -9 $childPID
   # exit 137 # 128+9

}

# Set SIGTERM handler
trap _term SIGTERM

# Set SIGKILL handler
trap _kill SIGKILL

> /etc/vsftpd/user_list

echo "Adding user ${FTP_ADM_NAME}"
htpasswd -c -p -b /etc/vsftpd/users_password "${FTP_ADM_NAME}" $(openssl passwd -1 -noverify "${FTP_ADM_PASS}")
echo "${FTP_ADM_NAME}" >> /etc/vsftpd/user_list

while read -r user; do
    IFS=: read -r FTP_USER_NAME FTP_USER_PASS FTP_USER_DIR FTP_USER_ACCESS <<< "${!user}"
    echo "Adding user ${FTP_USER_NAME}"
    htpasswd -c -p -b /etc/vsftpd/users_password "${FTP_USER_NAME}" $(openssl passwd -1 -noverify "${FTP_USER_PASS}")
    echo "${FTP_USER_NAME}" >> /etc/vsftpd/user_list
done < <(env | grep "FTP_USER_" | sed 's/^\(FTP_USER_[a-zA-Z0-9]*\)=.*/\1/')

ln -sf /dev/stdout /var/log/xferlog

vsftpd /etc/vsftpd/vsftpd.conf &

childPID=$!
wait $childPID
