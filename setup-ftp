#!/bin/bash

set -ex

# VARIABLES
FTP_ADM_NAME=${FTP_ADM_NAME:-"ftpadm"}
FTP_ADM_PASS=${FTP_ADM_PASS:-"1qaz@WSX"}

# $1 = $FTP_USER_NAME
# $2 = $FTP_USER_DIR
function f_rw_access() {

cat <<EOF > /etc/vsftpd/users_config/$1
    # the user home
    local_root=$2

    # he can write
    write_enable=YES

    # read-only disabled
    anon_world_readable_only=NO

    # he can upload
    anon_upload_enable=YES

    # he can create directories
    anon_mkdir_write_enable=YES

    # he can perform write operations other than upload and create directory
    anon_other_write_enable=YES

    # he has the same privileges as local local users
    virtual_use_local_privs=YES

    # masks
    local_umask=022
    anon_umask=022
EOF

}

# $1 = $FTP_USER_NAME
# $2 = $FTP_USER_DIR
function f_ro_access() {

cat <<EOF > /etc/vsftpd/users_config/$1
    # the user home
    local_root=$2

    # he can write
    write_enable=NO

    # read-only disabled
    anon_world_readable_only=NO

    # he can upload
    anon_upload_enable=YES

    # he can create directories
    anon_mkdir_write_enable=NO

    # he can perform write operations other than upload and create directory
    anon_other_write_enable=NO

    # he has the same privileges as local local users
    virtual_use_local_privs=YES

    # masks
    local_umask=022
    anon_umask=022
EOF

}

mkdir -p /etc/vsftpd/users_config

echo "Adding user ${FTP_ADM_NAME}"
echo "${FTP_ADM_NAME}" > /etc/vsftpd/user_list
echo -e "${FTP_ADM_NAME}\n${FTP_ADM_PASS}" > /etc/vsftpd/users_password.tmp
f_rw_access "${FTP_ADM_NAME}" "/var/ftp/pub"

while read -r user; do
    IFS=: read -r FTP_USER_NAME FTP_USER_PASS FTP_USER_DIR FTP_USER_ACCESS <<< "${!user}"
    echo "Adding user ${FTP_USER_NAME}"
    echo "${FTP_USER_NAME}" >> /etc/vsftpd/user_list
    echo -e "${FTP_USER_NAME}\n${FTP_USER_PASS}" >> /etc/vsftpd/users_password.tmp
done < <(env | grep "FTP_USER_" | sed 's/^\(FTP_USER_[a-zA-Z0-9]*\)=.*/\1/')

db_load -T -t hash -f /etc/vsftpd/users_password.tmp /etc/vsftpd/users_password.db
db_dump -p /etc/vsftpd/users_password.db

chown -R ftpsys:ftpsys /var/ftp/pub

touch /var/log/xferlog
# ln -sf /dev/stdout /var/log/xferlog

&>/dev/null /usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf
