#!/bin/bash

set -e

FTP_ADM_NAME=${FTP_ADM_NAME:-"admin"}
FTP_ADM_PASS=${FTP_ADM_PASS:-"passw0rd"}

FTP_FORCE_SSL=${FTP_FORCE_SSL:-"NO"}
FTP_LISTEN_PORT=${FTP_LISTEN_PORT:-"21"}
FTP_DATA_PORT=${FTP_DATA_PORT:-"20"}
FTP_PASV_MIN_PORT=${FTP_PASV_MIN_PORT:-"32500"}
FTP_PASV_MAX_PORT=${FTP_PASV_MAX_PORT:-"32599"}

DATE=$(date +%Y.%m.%d_%H.%M.%S_%N)

VSFTPD=/usr/sbin/vsftpd
VSFTPD_CONF=/etc/vsftpd/vsftpd.conf 
VSFTPD_WELCOME=/etc/vsftpd/vsftpd.welcome

VSFTPD_CERTIFICATE=/etc/vsftpd/vsftpd.pem
VSFTPD_CERTIFICATE_EXP=/etc/vsftpd/vsftpd.pkcs12

BDB_RAW=/etc/vsftpd/users_password
BDB=/etc/vsftpd/users_password.db

ROOT=$(grep -w ^local_root "${VSFTPD_CONF}" | cut -d= -f2)
NOPRIV_USER=$(grep -w ^nopriv_user "${VSFTPD_CONF}" | cut -d= -f2)
USERLIST_FILE=$(grep -w ^userlist_file "${VSFTPD_CONF}" | cut -d= -f2)
USER_CONFIG_DIR=$(grep -w ^user_config_dir "${VSFTPD_CONF}" | cut -d= -f2)
VSFTPD_LOG_FILE=$(grep -w ^vsftpd_log_file "${VSFTPD_CONF}" | cut -d= -f2)

# SIGTERM handler
function _term() {

   echo "Stopping container."
   echo "SIGTERM received, shutting down the server!"
   kill -15 $childPID
   exit 0 # 128+15

}

# SIGKILL handler
function _kill() {

   echo "SIGKILL received, shutting down the server!"
   kill -9 $childPID
   # exit 137 # 128+9

}

# $1 = PROPERTY
# $2 = VALUE
# $3 = FILE
function _update() {

    sed -i s~"\#\? \?${1} \?=.*"~"${1}=${2}"~g "${3}"

}

# $1 = $FTP_USER_NAME
# $2 = $FTP_USER_DIR
# $3 = $FTP_USER_MOD
# $4 = $FTP_USER_CWD
function _config() {

    local FTP_USER_NAME=$1
    local FTP_USER_DIR=$2
    local FTP_USER_MOD=$3
    local FTP_USER_CWD=$4

    local ROOT_MOD=$(echo "${ROOT}/" | tr -s / | sed 's/\/:/:/g;s/:/\n/g')
    local FTP_USER_DIR_MOD=$(echo "${FTP_USER_DIR}/" | tr -s / | sed 's/\/:/:/g;s/:/\n/g')

    if [ ! -d "${USER_CONFIG_DIR}" ]; then mkdir -p "${USER_CONFIG_DIR}"; fi

    echo "${FTP_USER_DIR_MOD,,}" | grep -q "^${ROOT_MOD,,}"

    if [ $? -eq 0 ]; then

        echo "local_root=${FTP_USER_DIR_MOD}" > "${USER_CONFIG_DIR}/${FTP_USER_NAME}"

        if [ ! -d "${FTP_USER_DIR_MOD}" ]; then mkdir -p "${FTP_USER_DIR_MOD}"; fi

        if [ "$(stat -c "%a" "${FTP_USER_DIR_MOD}")" -ne "770" ]; then chmod 0770 "${FTP_USER_DIR_MOD}"; fi 
        if [ "$(stat -c "%U" "${FTP_USER_DIR_MOD}")" != "${NOPRIV_USER}" ]; then chown "${NOPRIV_USER}" "${FTP_USER_DIR_MOD}"; fi
        if [ "$(stat -c "%G" "${FTP_USER_DIR_MOD}")" != "${NOPRIV_USER}" ]; then chgrp "${NOPRIV_USER}" "${FTP_USER_DIR_MOD}"; fi

        if [ "${FTP_USER_MOD^^}" == "RW" ]; then
            echo "write_enable=YES" >> "${USER_CONFIG_DIR}/${FTP_USER_NAME}"
        else
            echo "write_enable=NO" >> "${USER_CONFIG_DIR}/${FTP_USER_NAME}"
        fi

        if [ "${FTP_USER_CWD^^}" == "YES" ]; then
            echo "cmds_denied=none" >> "${USER_CONFIG_DIR}/${FTP_USER_NAME}"
        else
            echo "cmds_denied=CWD" >> "${USER_CONFIG_DIR}/${FTP_USER_NAME}"
        fi
    else
        exit 1

    fi

}

# Set SIGTERM handler
trap _term SIGTERM

# Set SIGKILL handler
trap _kill SIGKILL

if [ ! -z "${VSFTPD_LOG_FILE}" ]; then mkdir -p "$(dirname "${VSFTPD_LOG_FILE}")"; fi
if [ -f "${VSFTPD_LOG_FILE}" ]; then tar czf "${VSFTPD_LOG_FILE}.${DATE}.tgz" "${VSFTPD_LOG_FILE}" >/dev/null 2>&1; > "${VSFTPD_LOG_FILE}"; fi

if [ "${FTP_FORCE_SSL^^}" == "YES" ]; then
    _update "force_local_data_ssl" "YES" "${VSFTPD_CONF}"
    _update "force_local_logins_ssl" "YES" "${VSFTPD_CONF}"
else
    _update "force_local_data_ssl" "NO" "${VSFTPD_CONF}"
    _update "force_local_logins_ssl" "NO" "${VSFTPD_CONF}"
fi

if [[ "${FTP_LISTEN_PORT}" =~ ^[0-9]+$ ]]; then _update "listen_port" "${FTP_LISTEN_PORT}" "${VSFTPD_CONF}"; else exit 1; fi
if [[ "${FTP_DATA_PORT}" =~ ^[0-9]+$ ]]; then _update "ftp_data_port" "${FTP_DATA_PORT}" "${VSFTPD_CONF}"; else exit 1; fi

if [[ "${FTP_PASV_MIN_PORT}" =~ ^[0-9]+$ ]]; then _update "pasv_min_port" "${FTP_PASV_MIN_PORT}" "${VSFTPD_CONF}"; else exit 1; fi
if [[ "${FTP_PASV_MAX_PORT}" =~ ^[0-9]+$ ]]; then _update "pasv_max_port" "${FTP_PASV_MAX_PORT}" "${VSFTPD_CONF}"; else exit 1; fi

_config "${FTP_ADM_NAME}" "${ROOT}" "RW" "YES"
echo "${FTP_ADM_NAME}" > "${USERLIST_FILE}"
echo -e "${FTP_ADM_NAME}\n${FTP_ADM_PASS}" > "${BDB_RAW}"

while read -r user; do
    IFS=: read -r FTP_USER_NAME FTP_USER_PASS FTP_USER_DIR FTP_USER_MOD FTP_USER_CWD <<< "${!user}"
    if [ ! -z "${FTP_USER_NAME}" ] && [ ! -z "${FTP_USER_PASS}" ] && [ ! -z "${FTP_USER_DIR}" ] && [ ! -z "${FTP_USER_MOD}" ] && [ ! -z "${FTP_USER_CWD}" ]; then
        _config "${FTP_USER_NAME}" "${FTP_USER_DIR}" "${FTP_USER_MOD}" "${FTP_USER_CWD}"
        echo "${FTP_USER_NAME}" >> "${USERLIST_FILE}"
        echo -e "${FTP_USER_NAME}\n${FTP_USER_PASS}" >> "${BDB_RAW}"
    fi
done < <(env | grep "FTP_USER_" | sed 's/^\(FTP_USER_[a-zA-Z0-9]*\)=.*/\1/')

db_load -T -t hash -f "${BDB_RAW}" "${BDB}" # db_dump -p "${BDB}"

if [ ! -f "${VSFTPD_CERTIFICATE}" ]; then
    openssl req -x509 -nodes -days 36500 \
        -newkey rsa:2048 -keyout "${VSFTPD_CERTIFICATE}" -out "${VSFTPD_CERTIFICATE}" \
        -subj "/CN=FTP/C=RU/ST=MOSCOW/L=MOSCOW/O=COMPANY/OU=IT" >/dev/null 2>&1
    openssl pkcs12 -export -out "${VSFTPD_CERTIFICATE_EXP}" -in "${VSFTPD_CERTIFICATE}" -passout pass: >/dev/null 2>&1
fi

if [ ! -f "${BDB_RAW}" ]; then chmod 0600 "${BDB_RAW}"; fi
if [ ! -f "${BDB}" ]; then chmod 0600 "${BDB}"; fi
if [ ! -f "${VSFTPD_CERTIFICATE}" ]; then chmod 0600 "${VSFTPD_CERTIFICATE}"; fi
if [ ! -f "${VSFTPD_CERTIFICATE_EXP}" ]; then chmod 0600 "${VSFTPD_CERTIFICATE_EXP}"; fi

"${VSFTPD}" "${VSFTPD_CONF}" &
childPID=$!

cat "${VSFTPD_WELCOME}"

while true; do
    nc -z localhost ${FTP_LISTEN_PORT}
    if [ $? -eq 0 ]; then
        echo -e "* listening on port ${FTP_LISTEN_PORT}\n"
        break
    fi
    sleep 1
done

if [ ! -f "${VSFTPD_LOG_FILE}" ]; then touch "${VSFTPD_LOG_FILE}"; fi

tail -n 0 -q -F "${VSFTPD_LOG_FILE}" >> /proc/1/fd/1 &
# ln -sf /proc/1/fd/1 "${VSFTPD_LOG_FILE}"

wait $childPID
