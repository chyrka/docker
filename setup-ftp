#!/bin/bash

set -ex

# VARIABLES
FTP_ADM_NAME=${FTP_ADM_NAME:-"ftpadm"}
FTP_ADM_PASS=${FTP_ADM_PASS:-"1qaz@WSX"}

# $1 = $FTP_USER_NAME
# $2 = $FTP_USER_DIR
function f_rw_access() {

cat <<EOF > /etc/vsftpd/users_config/$1
local_root=$2
write_enable=YES
anon_world_readable_only=NO
anon_upload_enable=YES
anon_mkdir_write_enable=YES
anon_other_write_enable=YES
virtual_use_local_privs=YES
local_umask=022
anon_umask=022
EOF

}

# $1 = $FTP_USER_NAME
# $2 = $FTP_USER_DIR
function f_ro_access() {

cat <<EOF > /etc/vsftpd/users_config/$1
local_root=$2
write_enable=NO
anon_world_readable_only=NO
anon_upload_enable=YES
anon_mkdir_write_enable=NO
anon_other_write_enable=NO
virtual_use_local_privs=YES
local_umask=022
anon_umask=022
EOF

}

mkdir -p /etc/vsftpd/users_config

echo "Adding user ${FTP_ADM_NAME}"
echo "${FTP_ADM_NAME}" > /etc/vsftpd/user_list
echo -e "${FTP_ADM_NAME}\n${FTP_ADM_PASS}" > /etc/vsftpd/users_password.tmp
f_rw_access "${FTP_ADM_NAME}" "/var/ftp/pub"

while read -r user; do
    IFS=: read -r FTP_USER_NAME FTP_USER_PASS FTP_USER_DIR FTP_USER_ACCESS <<< "${!user}"
    echo "Adding user ${FTP_USER_NAME}"
    echo "${FTP_USER_NAME}" >> /etc/vsftpd/user_list
    echo -e "${FTP_USER_NAME}\n${FTP_USER_PASS}" >> /etc/vsftpd/users_password.tmp
done < <(env | grep "FTP_USER_" | sed 's/^\(FTP_USER_[a-zA-Z0-9]*\)=.*/\1/')

db_load -T -t hash -f /etc/vsftpd/users_password.tmp /etc/vsftpd/users_password.db
db_dump -p /etc/vsftpd/users_password.db

chown -R ftpdata:ftpdata /var/ftp/pub

LOG_FILE=$(grep xferlog_file /etc/vsftpd/vsftpd.conf|cut -d= -f2)
touch ${LOG_FILE}
ln -sf /dev/stdout ${LOG_FILE}

&>/dev/null /usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf
