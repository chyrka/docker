#!/bin/bash

set -ex

# VARIABLES
FTP_ADM_NAME=${FTP_ADM_NAME:-"ftpadm"}
FTP_ADM_PASS=${FTP_ADM_PASS:-"1qaz@WSX"}

# SIGTERM handler
function _term() {

   echo "Stopping container."
   echo "SIGTERM received, shutting down the server!"
   kill -15 $childPID
   exit 0 # 128+15

}

# SIGKILL handler
function _kill() {

   echo "SIGKILL received, shutting down the server!"
   kill -9 $childPID
   # exit 137 # 128+9

}

# $1 = $FTP_USER_NAME
# $2 = $FTP_USER_DIR
function rw_user_settings() {

cat <<EOF > /etc/vsftpd/users_config/$1
    # the user home
    local_root=$2

    # he can write
    write_enable=YES

    # read-only disabled
    anon_world_readable_only=NO

    # he can upload
    anon_upload_enable=YES

    # he can create directories
    anon_mkdir_write_enable=YES

    # he can perform write operations other than upload and create directory
    anon_other_write_enable=YES

    # he has the same privileges as local local users
    virtual_use_local_privs=YES

    # masks
    local_umask=022
    anon_umask=022
EOF

}

# $1 = $FTP_USER_NAME
# $2 = $FTP_USER_DIR
function ro_user_settings() {

cat <<EOF > /etc/vsftpd/users_config/$1
    # the user home
    local_root=$2

    # he can write
    write_enable=NO

    # read-only disabled
    anon_world_readable_only=NO

    # he can upload
    anon_upload_enable=YES

    # he can create directories
    anon_mkdir_write_enable=NO

    # he can perform write operations other than upload and create directory
    anon_other_write_enable=NO

    # he has the same privileges as local local users
    virtual_use_local_privs=YES

    # masks
    local_umask=022
    anon_umask=022
EOF

}

# Set SIGTERM handler
trap _term SIGTERM

# Set SIGKILL handler
trap _kill SIGKILL

> /etc/vsftpd/user_list
mkdir -p /etc/vsftpd/users_config

echo "Adding user ${FTP_ADM_NAME}"
htpasswd -c -p -b /etc/vsftpd/users_password "${FTP_ADM_NAME}" $(openssl passwd -1 -noverify "${FTP_ADM_PASS}")
echo "${FTP_ADM_NAME}" >> /etc/vsftpd/user_list

while read -r user; do
    IFS=: read -r FTP_USER_NAME FTP_USER_PASS FTP_USER_DIR FTP_USER_ACCESS <<< "${!user}"
    echo "Adding user ${FTP_USER_NAME}"
    htpasswd -c -p -b /etc/vsftpd/users_password "${FTP_USER_NAME}" $(openssl passwd -1 -noverify "${FTP_USER_PASS}")
    echo "${FTP_USER_NAME}" >> /etc/vsftpd/user_list
done < <(env | grep "FTP_USER_" | sed 's/^\(FTP_USER_[a-zA-Z0-9]*\)=.*/\1/')

ln -sf /dev/stdout /var/log/xferlog

vsftpd /etc/vsftpd/vsftpd.conf &

childPID=$!
wait $childPID
