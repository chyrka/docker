#!/bin/bash

set -e

# VARIABLES
FTP_ADM_NAME=${FTP_ADM_NAME:-"admin"}
FTP_ADM_PASS=${FTP_ADM_PASS:-"passw0rd"}

VSFTPD=/usr/sbin/vsftpd
VSFTPD_CONF=/etc/vsftpd/vsftpd.conf 
VSFTPD_WELCOME=/etc/vsftpd/vsftpd.welcome

BDB_TMP=/etc/vsftpd/users_password.tmp
BDB=/etc/vsftpd/users_password.db

ROOT=$(grep -w ^local_root "${VSFTPD_CONF}" | cut -d= -f2)
NOPRIV_USER=$(grep -w ^nopriv_user "${VSFTPD_CONF}" | cut -d= -f2)
USER_CONFIG_DIR=$(grep -w ^user_config_dir "${VSFTPD_CONF}" | cut -d= -f2)
USERLIST_FILE=$(grep -w ^userlist_file "${VSFTPD_CONF}" | cut -d= -f2)
XFERLOG_FILE=$(grep -w ^xferlog_file "${VSFTPD_CONF}" | cut -d= -f2)
VSFTPD_LOG_FILE=$(grep -w ^vsftpd_log_file "${VSFTPD_CONF}" | cut -d= -f2)

# SIGTERM handler
function _term() {

   echo "Stopping container."
   echo "SIGTERM received, shutting down the server!"
   kill -15 $childPID
   exit 0 # 128+15

}

# SIGKILL handler
function _kill() {

   echo "SIGKILL received, shutting down the server!"
   kill -9 $childPID
   # exit 137 # 128+9

}

# $1 = $FTP_USER_NAME
# $2 = $FTP_USER_DIR
function rw_access() {

cat <<EOF > /etc/vsftpd/users_config/$1
local_root=$2
write_enable=YES
EOF

}

# $1 = $FTP_USER_NAME
# $2 = $FTP_USER_DIR
function ro_access() {

cat <<EOF > /etc/vsftpd/users_config/$1
local_root=$2
write_enable=NO
EOF

}

cat "${VSFTPD_WELCOME}"

mkdir -p "${ROOT}"
chown -R ${NOPRIV_USER}:${NOPRIV_USER} "${ROOT}"

mkdir -p "${USER_CONFIG_DIR}"

echo "${FTP_ADM_NAME}" > "${USERLIST_FILE}"
echo -e "${FTP_ADM_NAME}\n${FTP_ADM_PASS}" > "${BDB_TMP}"
rw_access "${FTP_ADM_NAME}" "${ROOT}"

while read -r user; do
    IFS=: read -r FTP_USER_NAME FTP_USER_PASS FTP_USER_DIR FTP_USER_ACCESS <<< "${!user}"
    echo "${FTP_USER_NAME}" >> "${USERLIST_FILE}"
    echo -e "${FTP_USER_NAME}\n${FTP_USER_PASS}" >> "${BDB_TMP}"
done < <(env | grep "FTP_USER_" | sed 's/^\(FTP_USER_[a-zA-Z0-9]*\)=.*/\1/')

db_load -T -t hash -f "${BDB_TMP}" "${BDB}"
# db_dump -p "${BDB}"; rm -f "${BDB_TMP}"

if [ ! -z "${XFERLOG_FILE}" ]; then mkdir -p "$(dirname "${XFERLOG_FILE}")"; fi
if [ ! -z "${VSFTPD_LOG_FILE}" ]; then mkdir -p "$(dirname "${VSFTPD_LOG_FILE}")"; fi

&>/dev/null "${VSFTPD}" "${VSFTPD_CONF}" &
childPID=$!

while :; do
    &>/dev/null nc -zv localhost 21
    if [ $? -eq 0 ]; then
        echo -e "\n    vsftpd listening on port 21"
        break
    fi
    sleep 1
done

wait $childPID
